@page "/MineAnnoncer"
@using Core
@using MiniProjekt.Service
@inject IAnnonceService mService
@inject NavigationManager nav
@inject ILoginService mLogin


<h3 class="user-annoncer-header">@UserName's Annoncer</h3>

@if (annoncer == null)
{
    <p><em>Loading...</em></p>
}
else if (annoncer.Length == 0)
{
    <p>Ingen annoncer fundet.</p>
    <button class="btn-primary" @onclick="NavigateToAddAnnoncePage">Tilføj Annonce</button>
}
else
{
    <div class="annonce-list-container">

        @if (annoncer == null)
        {
            <p><em>Loading...</em></p>
        }
        else if (annoncer.Length == 0)
        {
            <p>Ingen annoncer fundet.</p>
            <button class="btn btn-primary add-annonce-btn" @onclick="NavigateToAddAnnoncePage">Tilføj Annonce</button>
        }
        else
        {
            <div class="annonce-grid">
                @foreach (var annonce in annoncer)
                {
                    <div class="annonce-card">
                        <div class="annonce-header">
                            <h3>@annonce.Title</h3>
                            <span class="category">@annonce.Category</span>
                        </div>
                        <img class="annonceImg" src="@annonce.Picture" alt="@annonce.Title" />
                        <p class="annonce-description">@annonce.Description</p>
                        <div class="annonce-details">
                            <span class="annonce-price">@annonce.Price kr.</span>
                            <span class="status @(annonce.Status == "Aktiv" ? "green" : annonce.Status == "Solgt" ? "red" : "")">
                                @annonce.Status
                            </span>
                        </div>
                        <p>Lokation: @annonce.Locations</p>
                        @if (annonce.Status == "Aktiv")
                        {
                            <div class="annonce-actions">
                                <button class="btn edit-btn" @onclick="() => EditAnnonce(annonce)">Rediger</button>
                                <button class="btn delete-btn" @onclick="() => DeleteById(annonce)">Slet</button>
                            </div>
                        }
                    </div>
                }
            </div>
            <button class="btn btn-primary add-annonce-btn" @onclick="NavigateToAddAnnoncePage">Tilføj Annonce</button>
        }
    </div>
}

@code {

    private Annonce[]? annoncer;
    private string UserName = "";

    protected override async Task OnInitializedAsync()
    {
        User? currentUser = await mLogin.GetUserLoggedIn();
        if (currentUser == null)
        {
            nav.NavigateTo("/LoginPage");
        }
        else
        {
            UserName = currentUser.Username; // Hent brugerens navn
            await LoadAll();
        }
    }
    

    private async Task LoadAll()
    {
        User? currentUser = await mLogin.GetUserLoggedIn();

        annoncer = await mService.GetAll();
        annoncer = annoncer.Where(a => a.SellerId == currentUser!.Id).ToArray();
    }

    private async Task DeleteById(Annonce annonce)
    {
        await mService.DeleteById(annonce.Id);
        await LoadAll();
    }

    private void NavigateToAddAnnoncePage()
    {
        nav.NavigateTo("/AddAnnoncePage");
    }

    private void EditAnnonce(Annonce annonce)
    {
        nav.NavigateTo($"/EditAnnoncePage/{annonce.Id}");
    }
    
}
